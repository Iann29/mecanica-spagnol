# üîê FASE 4: SISTEMA DE AUTENTICA√á√ÉO COMPLETO

## üìã Vis√£o Geral

A Fase 4 implementa todo o sistema de autentica√ß√£o do e-commerce Mec√¢nica Spagnol, incluindo login, cadastro, recupera√ß√£o de senha, prote√ß√£o de rotas e √°reas restritas.

**Dura√ß√£o estimada total**: 6-8 horas  
**Prioridade**: Alta  
**Depend√™ncias**: Fases 1, 2 e 3 conclu√≠das

---

## üéØ Objetivos da Fase 4

1. ‚úÖ Sistema de login/cadastro funcional
2. ‚úÖ Integra√ß√£o completa com Supabase Auth
3. ‚úÖ Prote√ß√£o de rotas e √°reas restritas
4. ‚úÖ Menu do usu√°rio no header
5. ‚úÖ √Årea do cliente (minha conta)
6. ‚úÖ Recupera√ß√£o de senha por email
7. ‚úÖ Valida√ß√£o e feedback em todos os formul√°rios
8. ‚úÖ Guards de autentica√ß√£o reutiliz√°veis

---

## üìä Subfases Detalhadas

### üîß Fase 4.1: Setup e Configura√ß√£o Base (1 hora) ‚úÖ

#### Objetivos:
- Configurar Supabase Auth no projeto
- Criar hooks customizados para auth
- Implementar contexto de autentica√ß√£o
- Configurar middleware de prote√ß√£o

#### Arquivos a criar/modificar:

1. **`src/lib/supabase/auth.ts`** - Fun√ß√µes de autentica√ß√£o
```typescript
// Fun√ß√µes: signIn, signUp, signOut, resetPassword, updateProfile
// Integra√ß√£o com Supabase Auth
// Tratamento de erros padronizado
```

2. **`src/hooks/use-auth.ts`** - Hook customizado
```typescript
// Estado do usu√°rio atual
// Fun√ß√µes de auth
// Loading states
// Error handling
```

3. **`src/contexts/auth-context.tsx`** - Contexto global
```typescript
// Provider para toda aplica√ß√£o
// Estado persistente do usu√°rio
// Refresh autom√°tico de sess√£o
```

4. **`src/middleware.ts`** - Atualizar com prote√ß√£o
```typescript
// Verifica√ß√£o de rotas protegidas
// Redirecionamento para login
// Verifica√ß√£o de roles (admin)
```

#### Valida√ß√£o:
- [x] Supabase Auth configurado corretamente
- [x] Hooks funcionando sem erros
- [x] Contexto dispon√≠vel em toda aplica√ß√£o
- [x] Middleware protegendo rotas corretas

---

### üé® Fase 4.2: P√°ginas de Autentica√ß√£o (2 horas) ‚úÖ

#### Objetivos:
- Criar p√°ginas de login e cadastro
- Implementar recupera√ß√£o de senha
- Adicionar valida√ß√£o com Zod
- UI consistente com shadcn/ui

#### Arquivos a criar:

1. **`src/app/(auth)/login/page.tsx`**
```typescript
// Formul√°rio de login
// Email + senha
// Link para cadastro e recupera√ß√£o
// Redirect ap√≥s sucesso
```

2. **`src/app/(auth)/cadastro/page.tsx`**
```typescript
// Formul√°rio de cadastro
// Nome, email, senha, telefone
// Cria√ß√£o autom√°tica de profile
// Termos de uso
```

3. **`src/app/(auth)/recuperar-senha/page.tsx`**
```typescript
// Formul√°rio de recupera√ß√£o
// Input de email
// Feedback de envio
// Instru√ß√µes claras
```

4. **`src/app/(auth)/layout.tsx`**
```typescript
// Layout espec√≠fico para auth
// Redirect se j√° logado
// Design limpo e focado
```

5. **`src/types/auth.ts`** - Tipos TypeScript
```typescript
// LoginFormData
// RegisterFormData
// ResetPasswordData
// AuthError types
```

6. **`src/lib/validations/auth.ts`** - Schemas Zod
```typescript
// loginSchema
// registerSchema
// resetPasswordSchema
// Mensagens em PT-BR
```

#### Componentes auxiliares:

7. **`src/components/auth/auth-form-wrapper.tsx`**
```typescript
// Wrapper reutiliz√°vel
// Logo e branding
// Loading states
```

8. **`src/components/auth/social-login.tsx`** (opcional)
```typescript
// Bot√µes para Google/Facebook
// Preparar estrutura
```

#### Valida√ß√£o:
- [x] Login funcional com email/senha
- [x] Cadastro cria usu√°rio e profile
- [x] Recupera√ß√£o envia email
- [x] Valida√ß√£o em todos os campos
- [x] Mensagens de erro claras
- [x] Redirect ap√≥s sucesso

---

### üîó Fase 4.3: Integra√ß√£o com Header (1 hora) ‚úÖ

#### Objetivos:
- Adicionar menu do usu√°rio no header
- Dropdown com op√ß√µes do usu√°rio
- Indicador visual de login
- Logout funcional

#### Arquivos a modificar:

1. **`src/components/layout/header.tsx`** - Atualizar
```typescript
// Adicionar UserMenu component
// Mostrar nome/avatar quando logado
// Bot√£o login quando deslogado
```

2. **`src/components/layout/user-menu.tsx`** - Criar
```typescript
// Dropdown menu
// Op√ß√µes: Minha conta, Pedidos, Sair
// Avatar ou inicial do nome
// Anima√ß√µes suaves
```

3. **`src/components/layout/mobile-menu.tsx`** - Atualizar
```typescript
// Adicionar op√ß√µes de usu√°rio
// Estado de login/logout
// Links apropriados
```

#### Valida√ß√£o:
- [x] Menu aparece quando logado
- [x] Bot√£o login quando deslogado
- [x] Dropdown funcional com todas op√ß√µes
- [x] Logout limpa sess√£o corretamente
- [x] Mobile responsivo

---

### üõ°Ô∏è Fase 4.4: Guards e Prote√ß√£o de Rotas (1 hora)

#### Objetivos:
- Criar HOCs para prote√ß√£o
- Implementar verifica√ß√£o de roles
- Loading e redirects autom√°ticos
- Prote√ß√£o de √°reas admin

#### Arquivos a criar:

1. **`src/components/auth/auth-guard.tsx`**
```typescript
// HOC para p√°ginas protegidas
// Verifica autentica√ß√£o
// Redirect para login
// Loading state
```

2. **`src/components/auth/admin-guard.tsx`**
```typescript
// Verifica role admin
// Redirect para home se n√£o autorizado
// Mensagem de erro
```

3. **`src/components/auth/guest-guard.tsx`**
```typescript
// Para p√°ginas de auth
// Redirect se j√° logado
// Previne loops
```

4. **`src/lib/auth/permissions.ts`**
```typescript
// Fun√ß√µes helper
// checkIsAdmin()
// checkIsOwner()
// canAccessRoute()
```

#### Aplicar guards em:
- `/minha-conta/*` - AuthGuard
- `/admin/*` - AdminGuard
- `/login`, `/cadastro` - GuestGuard

#### Valida√ß√£o:
- [ ] Rotas protegidas redirecionam
- [ ] Admin s√≥ acessa com role correto
- [ ] Loading states funcionando
- [ ] Sem loops de redirect
- [ ] Mensagens de erro apropriadas

---

### üë§ Fase 4.5: √Årea do Usu√°rio (1.5 horas)

#### Objetivos:
- Dashboard do cliente
- Edi√ß√£o de perfil
- Gest√£o de endere√ßos
- Visualiza√ß√£o de pedidos

#### Arquivos a criar:

1. **`src/app/(user)/minha-conta/page.tsx`**
```typescript
// Dashboard com resumo
// Dados pessoais
// √öltimos pedidos
// Links r√°pidos
```

2. **`src/app/(user)/minha-conta/perfil/page.tsx`**
```typescript
// Formul√°rio de edi√ß√£o
// Nome, telefone, CPF
// Upload de avatar (futuro)
// Salvar altera√ß√µes
```

3. **`src/app/(user)/minha-conta/enderecos/page.tsx`**
```typescript
// Lista de endere√ßos
// Adicionar novo
// Editar/excluir
// Marcar como padr√£o
```

4. **`src/app/(user)/minha-conta/seguranca/page.tsx`**
```typescript
// Alterar senha
// Email de recupera√ß√£o
// Hist√≥rico de sess√µes (futuro)
```

5. **`src/app/(user)/layout.tsx`**
```typescript
// Layout com sidebar
// Menu lateral
// Breadcrumbs
// Prote√ß√£o com AuthGuard
```

6. **`src/components/user/account-sidebar.tsx`**
```typescript
// Menu lateral
// Links ativos
// √çcones consistentes
// Mobile responsive
```

7. **`src/lib/validations/profile.ts`**
```typescript
// profileUpdateSchema
// addressSchema
// passwordChangeSchema
```

#### Valida√ß√£o:
- [ ] Todas p√°ginas protegidas
- [ ] Formul√°rios salvam corretamente
- [ ] Valida√ß√£o funcionando
- [ ] Feedback visual de sucesso/erro
- [ ] Layout consistente
- [ ] Mobile responsivo

---

### ‚úÖ Fase 4.6: Testes e Valida√ß√£o Final (0.5 hora)

#### Checklist de testes:

1. **Fluxo de Cadastro**:
   - [ ] Criar nova conta
   - [ ] Receber email de confirma√ß√£o
   - [ ] Profile criado automaticamente
   - [ ] Login autom√°tico ap√≥s cadastro

2. **Fluxo de Login**:
   - [ ] Login com credenciais v√°lidas
   - [ ] Erro com credenciais inv√°lidas
   - [ ] Remember me (se implementado)
   - [ ] Redirect para p√°gina anterior

3. **Recupera√ß√£o de Senha**:
   - [ ] Solicitar reset
   - [ ] Receber email
   - [ ] Criar nova senha
   - [ ] Login com nova senha

4. **Prote√ß√£o de Rotas**:
   - [ ] `/minha-conta` redireciona se n√£o logado
   - [ ] `/admin` s√≥ acessa como admin
   - [ ] `/login` redireciona se j√° logado
   - [ ] Middleware funcionando

5. **Menu do Usu√°rio**:
   - [ ] Mostra nome quando logado
   - [ ] Dropdown com todas op√ß√µes
   - [ ] Logout limpa sess√£o
   - [ ] Mobile funcionando

6. **√Årea do Cliente**:
   - [ ] Visualizar dados
   - [ ] Editar perfil
   - [ ] Gerenciar endere√ßos
   - [ ] Ver pedidos (quando houver)

---

## üöÄ Comandos √öteis

```bash
# Testar localmente
npm run dev

# Verificar tipos
npm run type-check

# Lint
npm run lint

# Build
npm run build
```

---

## üìù Notas de Implementa√ß√£o

### Configura√ß√£o Supabase Auth:
1. No painel Supabase:
   - Ativar provider Email
   - Configurar templates de email em PT-BR
   - URL de redirect: `http://localhost:3000/auth/callback`
   - Configurar SMTP (produ√ß√£o)

2. Vari√°veis de ambiente necess√°rias:
```env
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

### Boas pr√°ticas:
- Sempre usar tipos TypeScript
- Tratamento de erros em todas opera√ß√µes
- Loading states em todas a√ß√µes ass√≠ncronas
- Mensagens de feedback claras
- Valida√ß√£o client e server-side
- Logs de seguran√ßa em a√ß√µes sens√≠veis

### Seguran√ßa:
- Nunca expor service_role_key no cliente
- Validar inputs com Zod
- Rate limiting nas rotas de auth
- Prevenir user enumeration
- HTTPS obrigat√≥rio em produ√ß√£o
- Tokens seguros e HttpOnly cookies

---

## ‚ú® Entreg√°veis da Fase 4

Ao final desta fase, teremos:

1. ‚úÖ Sistema completo de autentica√ß√£o
2. ‚úÖ Login/Cadastro funcionais
3. ‚úÖ Recupera√ß√£o de senha por email
4. ‚úÖ Prote√ß√£o de rotas implementada
5. ‚úÖ Menu do usu√°rio integrado
6. ‚úÖ √Årea do cliente completa
7. ‚úÖ Guards reutiliz√°veis
8. ‚úÖ Valida√ß√£o em todos formul√°rios
9. ‚úÖ Feedback visual apropriado
10. ‚úÖ Sistema seguro e testado

---

## üéØ Pr√≥ximos Passos (Fase 5)

Ap√≥s concluir a Fase 4, seguiremos para:
- Sistema de produtos e categorias
- Listagem e busca
- P√°gina individual do produto
- Sistema de carrinho
- Integra√ß√£o com Zustand

---

**√öltima atualiza√ß√£o**: 17/01/2025  
**Status**: Fases 4.1, 4.2 e 4.3 conclu√≠das ‚úÖ

## üìã Arquivos Implementados

### Fase 4.1:
- ‚úÖ `src/lib/supabase/auth.ts` - Fun√ß√µes de autentica√ß√£o
- ‚úÖ `src/hooks/use-auth.ts` - Hook customizado  
- ‚úÖ `src/contexts/auth-context.tsx` - Contexto global
- ‚úÖ `src/middleware.ts` - Prote√ß√£o de rotas
- ‚úÖ `src/types/auth.ts` - Tipos TypeScript
- ‚úÖ `src/lib/validations/auth.ts` - Schemas Zod
- ‚úÖ `src/lib/auth/permissions.ts` - Sistema de permiss√µes

### Fase 4.2:
- ‚úÖ `src/app/(auth)/layout.tsx` - Layout para auth
- ‚úÖ `src/components/auth/auth-form-wrapper.tsx` - Wrapper reutiliz√°vel
- ‚úÖ `src/app/(auth)/login/page.tsx` - P√°gina de login
- ‚úÖ `src/app/(auth)/cadastro/page.tsx` - P√°gina de cadastro
- ‚úÖ `src/app/(auth)/recuperar-senha/page.tsx` - Recupera√ß√£o de senha
- ‚úÖ `src/app/(auth)/auth/callback/route.ts` - Callback de confirma√ß√£o
- ‚úÖ `src/components/ui/checkbox.tsx` - Componente checkbox (adicionado)

### Fase 4.3:
- ‚úÖ `src/components/layout/user-menu.tsx` - Menu dropdown do usu√°rio
- ‚úÖ `src/components/layout/mobile-menu.tsx` - Menu lateral mobile
- ‚úÖ `src/components/layout/header.tsx` - Header atualizado com auth real
- ‚úÖ `src/components/ui/avatar.tsx` - Componente avatar (adicionado)